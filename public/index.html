<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EventHorizon Event Management Portal</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        h1, h2 { text-align: center; }
        form div { margin-bottom: 10px; }
        label { display: block; margin-bottom: 5px; }
        input[type="text"], input[type="password"], input[type="datetime-local"], input[type="number"], textarea, select {
            width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px;
        }
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        .message { margin-top: 10px; padding: 10px; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        #eventsList, #myRegistrationsList, #eventRegistrationsList { margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; }
        .event-item, .registration-item { border: 1px solid #eee; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
        .event-item h3, .registration-item h3 { margin-top: 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>EventHorizon Event Management Portal</h1>

        <div id="authSection">
            <h2>Register / Login</h2>
            <form id="authForm">
                <div>
                    <label for="username">Username:</label>
                    <input type="text" id="username" required>
                </div>
                <div>
                    <label for="password">Password:</label>
                    <input type="password" id="password" required>
                </div>
                <div>
                    <label for="role">Role:</label>
                    <select id="role">
                        <option value="Attendee">Attendee</option>
                        <option value="Organizer">Organizer</option>
                    </select>
                </div>
                <button type="submit" id="registerBtn">Register</button>
                <button type="submit" id="loginBtn">Login</button>
            </form>
            <div id="authMessage" class="message"></div>
        </div>

        <div id="loggedInSection" style="display: none;">
            <h2>Welcome, <span id="loggedInUser"></span> (<span id="loggedInRole"></span>)!</h2>
            <button id="logoutBtn">Logout</button>

            <div id="organizerSection" style="display: none;">
                <h3>Manage Events</h3>
                <form id="createEventForm">
                    <h4>Create New Event</h4>
                    <div>
                        <label for="eventName">Event Name:</label>
                        <input type="text" id="eventName" required>
                    </div>
                    <div>
                        <label for="eventDate">Date & Time:</label>
                        <input type="datetime-local" id="eventDate" required>
                    </div>
                    <div>
                        <label for="description">Description:</label>
                        <textarea id="description"></textarea>
                    </div>
                    <div>
                        <label for="location">Location:</label>
                        <input type="text" id="location" required>
                    </div>
                    <div>
                        <label for="capacity">Capacity:</label>
                        <input type="number" id="capacity" required>
                    </div>
                    <button type="submit">Create Event</button>
                </form>
                <div id="eventMessage" class="message"></div>

                <h4>Your Events</h4>
                <div id="organizerEventsList"></div>
            </div>

            <div id="attendeeSection" style="display: none;">
                <h3>Upcoming Events</h3>
                <div id="eventsList"></div>

                <h3>My Registrations</h3>
                <div id="myRegistrationsList"></div>
            </div>
        </div>
    </div>

    <script>
      const authForm = document.getElementById('authForm');
    const registerBtn = document.getElementById('registerBtn');
    const loginBtn = document.getElementById('loginBtn');
    const authMessage = document.getElementById('authMessage');
    const loggedInSection = document.getElementById('loggedInSection');
    const loggedInUserSpan = document.getElementById('loggedInUser');
    const loggedInRoleSpan = document.getElementById('loggedInRole');
    const logoutBtn = document.getElementById('logoutBtn');
    const organizerSection = document.getElementById('organizerSection');
    const attendeeSection = document.getElementById('attendeeSection');
    const createEventForm = document.getElementById('createEventForm');
    const eventMessage = document.getElementById('eventMessage');
    const eventsList = document.getElementById('eventsList');
    const myRegistrationsList = document.getElementById('myRegistrationsList');
    const organizerEventsList = document.getElementById('organizerEventsList');

    let token = localStorage.getItem('jwtToken');
    let userRole = localStorage.getItem('userRole');
    let username = localStorage.getItem('username');

    function showMessage(element, msg, type) {
        element.textContent = msg;
        element.className = `message ${type}`;
        setTimeout(() => element.textContent = '', 5000);
    }

    function updateUI() {
        if (token && username && userRole) {
            authSection.style.display = 'none';
            loggedInSection.style.display = 'block';
            loggedInUserSpan.textContent = username;
            loggedInRoleSpan.textContent = userRole;

            if (userRole === 'Organizer') {
                organizerSection.style.display = 'block';
                attendeeSection.style.display = 'none';
                fetchOrganizerEvents();
            } else {
                organizerSection.style.display = 'none';
                attendeeSection.style.display = 'block';
                fetchPublicEvents();
                fetchMyRegistrations();
            }
        } else {
            authSection.style.display = 'block';
            loggedInSection.style.display = 'none';
            organizerSection.style.display = 'none';
            attendeeSection.style.display = 'none';
            fetchPublicEvents(); // Show public events even if not logged in
        }
    }

    // --- Authentication ---
    authForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        username = document.getElementById('username').value;  // ✅ no const here
        const password = document.getElementById('password').value;
        const role = document.getElementById('role').value;

        const url = e.submitter.id === 'registerBtn' ? '/api/auth/register' : '/api/auth/login';
        const method = 'POST';
        const body = JSON.stringify({ username, password, role });

        try {
            const res = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body
            });
            const data = await res.json();

            if (res.ok) {
    showMessage(authMessage, data.message, 'success');

    if (url === '/api/auth/login') {
        token = data.token;
        userRole = data.role;
        username = document.getElementById('username').value;
        const userId = data.userId; // ✅ Get userId from response

        localStorage.setItem('jwtToken', token);
        localStorage.setItem('userRole', userRole);
        localStorage.setItem('username', username);
        localStorage.setItem('userId', userId); // ✅ Store userId

        updateUI();
    }
}
else {
                showMessage(authMessage, data.message || 'Error', 'error');
            }
        } catch (error) {
            console.error('Auth error:', error);
            showMessage(authMessage, 'Network error or server unreachable.', 'error');
        }
    });

        logoutBtn.addEventListener('click', () => {
            token = null;
            userRole = null;
            username = null;
            localStorage.removeItem('jwtToken');
            localStorage.removeItem('userRole');
            localStorage.removeItem('username');
            updateUI();
            showMessage(authMessage, 'Logged out successfully.', 'success');
        });

        // --- Event Management (Organizer) ---
        createEventForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const eventName = document.getElementById('eventName').value;
            const eventDate = document.getElementById('eventDate').value;
            const description = document.getElementById('description').value;
            const location = document.getElementById('location').value;
            const capacity = parseInt(document.getElementById('capacity').value);

            try {
                const res = await fetch('/api/events', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ eventName, eventDate, description, location, capacity })
                });
                const data = await res.json();

                if (res.ok) {
                    showMessage(eventMessage, data.message, 'success');
                    createEventForm.reset();
                    fetchOrganizerEvents();
                } else {
                    showMessage(eventMessage, data.message || 'Error creating event.', 'error');
                }
            } catch (error) {
                console.error('Create event error:', error);
                showMessage(eventMessage, 'Network error or server unreachable.', 'error');
            }
        });

        async function fetchOrganizerEvents() {
            try {
                const res = await fetch('/api/events', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const events = await res.json();
                organizerEventsList.innerHTML = '<h4>Your Created Events:</h4>';
                if (events.length === 0) {
                    organizerEventsList.innerHTML += '<p>No events created yet.</p>';
                    return;
                }
                events.forEach(event => {
                    const eventDiv = document.createElement('div');
                    eventDiv.className = 'event-item';
                    eventDiv.innerHTML = `
                        <h3>${event.EventName}</h3>
                        <p><strong>Date:</strong> ${new Date(event.EventDate).toLocaleString()}</p>
                        <p><strong>Location:</strong> ${event.Location}</p>
                        <p><strong>Capacity:</strong> ${event.Capacity}</p>
                        <p>${event.Description || ''}</p>
                        <button onclick="editEvent(${event.EventID})">Edit</button>
                        <button onclick="deleteEvent(${event.EventID})">Delete</button>
                        <button onclick="fetchEventRegistrations(${event.EventID})">View Registrations</button>
                        <div id="registrationsForEvent-${event.EventID}" style="margin-top: 10px;"></div>
                    `;
                    organizerEventsList.appendChild(eventDiv);
                });
            } catch (error) {
                console.error('Error fetching organizer events:', error);
                organizerEventsList.innerHTML = '<p class="error">Error loading your events.</p>';
            }
        }

        async function editEvent(eventId) {
    try {
        const res = await fetch(`/api/events`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const events = await res.json();
        const event = events.find(ev => ev.EventID === eventId);
        if (!event) return alert('Event not found.');

        const eventDiv = document.querySelector(`.event-item button[onclick="editEvent(${eventId})"]`).parentElement;

        eventDiv.innerHTML = `
            <h3>Edit: ${event.EventName}</h3>
            <form onsubmit="submitEditEvent(event, ${event.EventID})">
                <label>Name: <input type="text" id="editName-${eventId}" value="${event.EventName}" required></label><br>
                <label>Date: <input type="datetime-local" id="editDate-${eventId}" value="${new Date(event.EventDate).toISOString().slice(0,16)}" required></label><br>
                <label>Location: <input type="text" id="editLocation-${eventId}" value="${event.Location}" required></label><br>
                <label>Capacity: <input type="number" id="editCapacity-${eventId}" value="${event.Capacity}" required></label><br>
                <label>Description: <textarea id="editDescription-${eventId}">${event.Description || ''}</textarea></label><br>
                <button type="submit">Save</button>
                <button type="button" onclick="fetchOrganizerEvents()">Cancel</button>
            </form>
        `;
    } catch (err) {
        console.error('Edit event error:', err);
        alert('Error loading event details.');
    }
}
async function submitEditEvent(e, eventId) {
        e.preventDefault();
        const eventName = document.getElementById(`editName-${eventId}`).value;
        const eventDate = document.getElementById(`editDate-${eventId}`).value;
        const location = document.getElementById(`editLocation-${eventId}`).value;
        const capacity = parseInt(document.getElementById(`editCapacity-${eventId}`).value);
        const description = document.getElementById(`editDescription-${eventId}`).value;

        try {
            const res = await fetch(`/api/events/${eventId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ eventName, eventDate, location, capacity, description })
            });
            const data = await res.json();
            if (res.ok) {
                alert('Event updated successfully!');
                fetchOrganizerEvents(); // reload event list
            } else {
                alert(data.message || 'Failed to update event.');
            }
        } catch (err) {
            console.error('Update event error:', err);
            alert('Error updating event.');
        }
    }


        async function deleteEvent(eventId) {
            if (!confirm('Are you sure you want to delete this event? This will also delete all registrations for it.')) {
                return;
            }
            try {
                const res = await fetch(`/api/events/${eventId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (res.ok) {
                    showMessage(eventMessage, data.message, 'success');
                    fetchOrganizerEvents();
                } else {
                    showMessage(eventMessage, data.message || 'Error deleting event.', 'error');
                }
            } catch (error) {
                console.error('Delete event error:', error);
                showMessage(eventMessage, 'Network error or server unreachable.', 'error');
            }
        }

        async function fetchEventRegistrations(eventId) {
            const registrationsDiv = document.getElementById(`registrationsForEvent-${eventId}`);
            registrationsDiv.innerHTML = '<p>Loading registrations...</p>';
            try {
                const res = await fetch(`/api/registrations/event/${eventId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const registrations = await res.json();
                registrationsDiv.innerHTML = '<h5>Registrations:</h5>';
                if (registrations.length === 0) {
                    registrationsDiv.innerHTML += '<p>No registrations for this event yet.</p>';
                    return;
                }
                registrations.forEach(reg => {
                    const regItem = document.createElement('div');
                    regItem.innerHTML = `
                        <p><strong>Attendee:</strong> ${reg.AttendeeName} (ID: ${reg.AttendeeID})</p>
                        <p><strong>Registered On:</strong> ${new Date(reg.RegistrationDate).toLocaleString()}</p>
                        <p><strong>Status:</strong> ${reg.PaymentStatus}
                            <select onchange="updateRegistrationStatus(${reg.RegistrationID}, this.value)">
                                <option value="Pending" ${reg.PaymentStatus === 'Pending' ? 'selected' : ''}>Pending</option>
                                <option value="Paid" ${reg.PaymentStatus === 'Paid' ? 'selected' : ''}>Paid</option>
                                <option value="Refunded" ${reg.PaymentStatus === 'Refunded' ? 'selected' : ''}>Refunded</option>
                            </select>
                        </p>
                        <hr>
                    `;
                    registrationsDiv.appendChild(regItem);
                });
            } catch (error) {
                console.error('Error fetching event registrations:', error);
                registrationsDiv.innerHTML = '<p class="error">Error loading registrations.</p>';
            }
        }

        async function updateRegistrationStatus(registrationId, newStatus) {
            try {
                const res = await fetch(`/api/registrations/${registrationId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ paymentStatus: newStatus })
                });
                const data = await res.json();
                if (res.ok) {
                    showMessage(eventMessage, data.message, 'success');
                    // Re-fetch registrations for the specific event or just update UI
                    // For simplicity, we'll just alert for now. In a real app, you'd re-render.
                    alert('Registration status updated!');
                } else {
                    showMessage(eventMessage, data.message || 'Error updating status.', 'error');
                }
            } catch (error) {
                console.error('Update registration status error:', error);
                showMessage(eventMessage, 'Network error or server unreachable.', 'error');
            }
        }


        // --- Event Browsing & Registration (Attendee) ---
        async function fetchPublicEvents() {
            try {
                const res = await fetch('/api/events'); // No auth needed for public view
                const events = await res.json();
                eventsList.innerHTML = '';
                if (events.length === 0) {
                    eventsList.innerHTML = '<p>No upcoming events available.</p>';
                    return;
                }
                events.forEach(event => {
                    const eventDiv = document.createElement('div');
                    eventDiv.className = 'event-item';
                    eventDiv.innerHTML = `
                        <h3>${event.EventName}</h3>
                        <p><strong>Date:</strong> ${new Date(event.EventDate).toLocaleString()}</p>
                        <p><strong>Location:</strong> ${event.Location}</p>
                        <p><strong>Capacity:</strong> ${event.Capacity}</p>
                        <p>${event.Description || ''}</p>
                        ${userRole === 'Attendee' ? `<button onclick="registerForEvent(${event.EventID})">Register</button>` : ''}
                    `;
                    eventsList.appendChild(eventDiv);
                });
            } catch (error) {
                console.error('Error fetching public events:', error);
                eventsList.innerHTML = '<p class="error">Error loading events.</p>';
            }
        }

        async function registerForEvent(eventId) {
            if (!token || userRole !== 'Attendee') {
                alert('Please log in as an Attendee to register for events.');
                return;
            }
            try {
                const res = await fetch('/api/registrations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ eventId })
                });
                const data = await res.json();
                if (res.ok) {
                    alert(data.message);
                    fetchMyRegistrations(); // Refresh my registrations list
                } else {
                    alert(data.message || 'Error registering for event.');
                }
            } catch (error) {
                console.error('Register event error:', error);
                alert('Network error or server unreachable.');
            }
        }

        async function fetchMyRegistrations() {
            if (!token || userRole !== 'Attendee') {
                myRegistrationsList.innerHTML = '<p>Log in as an Attendee to view your registrations.</p>';
                return;
            }
            try {
                const res = await fetch('/api/registrations/my-registrations', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const registrations = await res.json();
                myRegistrationsList.innerHTML = '<h4>Your Registered Events:</h4>';
                if (registrations.length === 0) {
                    myRegistrationsList.innerHTML += '<p>You have not registered for any events yet.</p>';
                    return;
                }
                registrations.forEach(reg => {
                    const regDiv = document.createElement('div');
                    regDiv.className = 'registration-item';
                    regDiv.innerHTML = `
                        <h3>${reg.EventName}</h3>
                        <p><strong>Date:</strong> ${new Date(reg.EventDate).toLocaleString()}</p>
                        <p><strong>Location:</strong> ${reg.Location}</p>
                        <p><strong>Status:</strong> ${reg.PaymentStatus}</p>
                        <button onclick="cancelRegistration(${reg.RegistrationID})">Cancel Registration</button>
                    `;
                    myRegistrationsList.appendChild(regDiv);
                });
            } catch (error) {
                console.error('Error fetching my registrations:', error);
                myRegistrationsList.innerHTML = '<p class="error">Error loading your registrations.</p>';
            }
        }

        async function cancelRegistration(registrationId) {
            if (!confirm('Are you sure you want to cancel this registration?')) {
                return;
            }
            try {
                const res = await fetch(`/api/registrations/${registrationId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (res.ok) {
                    alert(data.message);
                    fetchMyRegistrations(); // Refresh my registrations list
                } else {
                    alert(data.message || 'Error cancelling registration.');
                }
            } catch (error) {
                console.error('Cancel registration error:', error);
                alert('Network error or server unreachable.');
            }
        }

        // Initial UI update on page load
        updateUI();
    </script>
</body>
</html>
